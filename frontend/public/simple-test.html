<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç AutoSpeak</title>
    <link rel="stylesheet" href="widget-animated.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        .test-area {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-area">
        <h2>üîä –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç AutoSpeak</h2>
        
        <button class="btn" onclick="sendTestMessage()">üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
        <button class="btn" onclick="toggleAutoSpeak()">üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å AutoSpeak</button>
        <button class="btn" onclick="clearLog()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        
        <div>
            <strong>AutoSpeak:</strong> <span id="autoSpeakStatus">–≤–∫–ª—é—á–µ–Ω</span>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <!-- Voice Widget Scripts -->
    <script src="utils.js"></script>
    <script src="api-client.js"></script>
    <script src="voice-recognition.js"></script>
    <script src="voice-synthesis.js"></script>
    <script src="voice-widget.js"></script>

    <script>
        let widget;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.innerHTML = `[${time}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function updateAutoSpeakStatus() {
            const status = widget ? (widget.options.autoSpeak ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω') : '–Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω';
            document.getElementById('autoSpeakStatus').textContent = status;
        }
        
        function toggleAutoSpeak() {
            if (widget) {
                widget.options.autoSpeak = !widget.options.autoSpeak;
                log(`üîÑ AutoSpeak ${widget.options.autoSpeak ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}`);
                updateAutoSpeakStatus();
            }
        }
        
        async function sendTestMessage() {
            if (!widget) {
                log('‚ùå –í–∏–¥–∂–µ—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...');
            
            try {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
                if (!widget.isOpen) {
                    widget.togglePanel();
                    log('üì± –ü–∞–Ω–µ–ª—å –≤–∏–¥–∂–µ—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∞');
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç
                const testText = '–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–∑–≤—É—á–∫–∏.';
                widget.elements.input.value = testText;
                log(`üí¨ –¢–µ–∫—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: "${testText}"`);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                log('üöÄ –í—ã–∑—ã–≤–∞–µ–º handleSendMessage()...');
                await widget.handleSendMessage();
                
                log('‚úÖ handleSendMessage() –∑–∞–≤–µ—Ä—à–µ–Ω');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞...');
        
        try {
            widget = new VoiceWidget({
                debug: true,
                autoSpeak: true,
                preferOpenAITTS: false,
                autoInit: true
            });
            
            log('‚úÖ –í–∏–¥–∂–µ—Ç —Å–æ–∑–¥–∞–Ω');
            
            // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            setTimeout(() => {
                if (widget.isInitialized) {
                    log('‚úÖ –í–∏–¥–∂–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    updateAutoSpeakStatus();
                    
                    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ speakAssistantResponse –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    const originalSpeak = widget.speakAssistantResponse.bind(widget);
                    widget.speakAssistantResponse = async function(text) {
                        log(`üéµ speakAssistantResponse() –≤—ã–∑–≤–∞–Ω —Å —Ç–µ–∫—Å—Ç–æ–º: "${text.substring(0, 50)}..."`);
                        log(`üîç autoSpeak –Ω–∞—Å—Ç—Ä–æ–π–∫–∞: ${this.options.autoSpeak}`);
                        
                        try {
                            const result = await originalSpeak(text);
                            log('‚úÖ speakAssistantResponse() –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                            return result;
                        } catch (error) {
                            log(`‚ùå speakAssistantResponse() –æ—à–∏–±–∫–∞: ${error.message}`);
                            throw error;
                        }
                    };
                    
                    log('üîç –ú–µ—Ç–æ–¥ speakAssistantResponse() –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏');
                    
                } else {
                    log('‚ùå –í–∏–¥–∂–µ—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã');
                }
            }, 2000);
            
        } catch (error) {
            log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞: ${error.message}`);
        }
    </script>
</body>
</html>
